<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey Form | SJCB Household Profiling</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        .preview-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .preview-section h5 {
            color: #457507;
            border-bottom: 2px solid #457507;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .data-row {
            display: flex;
            border-bottom: 1px solid #eee;
            padding: 8px 0;
        }
        .data-row:last-child {
            border-bottom: none;
        }
        .data-label {
            font-weight: 600;
            width: 40%;
            color: #555;
        }
        .data-value {
            width: 60%;
            color: #333;
        }
        .member-table {
            width: 100%;
            font-size: 0.85rem;
        }
        .member-table th {
            background-color: #457507;
            color: white;
            padding: 8px;
            text-align: center;
        }
        .member-table td {
            padding: 6px;
            border: 1px solid #ddd;
            text-align: center;
        }
    </style>
</head>

<body class="d-flex flex-column min-vh-100 bg-light">
    <!-- header -->
    <nav class="navbar shadow-sm py-3" style="background-color:#457507;">
        <div class="container-fluid px-4 d-flex justify-content-between align-items-center">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none">
                <img class="rounded-circle" src="/images/logo.jpg" width="45" height="45" class="me-2">
                <span class="fw-bold fs-4 mx-2 text-white">Archdiocese of Tuguegarao</span>
            </a>
        </div>
    </nav>

    <main class="flex-grow-1 d-flex p-0">
        <div class="container-fluid bg-light p-4">
            <div class="progress mb-4" style="height: 25px;">
                <div class="progress-bar bg-success" role="progressbar" style="width: 100%;">
                    Survey Complete - Preview
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header text-center fw-bold bg-light">
                    SURVEY PREVIEW - REVIEW YOUR INFORMATION
                </div>
                <div class="card-body">
                    <div id="previewContent">
                        <!-- General Information -->
                        <div class="preview-section">
                            <h5>I. GENERAL INFORMATION</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="data-row">
                                        <span class="data-label">BEC Purok-Gimong:</span>
                                        <span class="data-value" id="gen-purokGimong">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Barangay Name:</span>
                                        <span class="data-value" id="gen-barangayName">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Municipality Name:</span>
                                        <span class="data-value" id="gen-municipalityselect">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Province Name:</span>
                                        <span class="data-value" id="gen-provinceName">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Mode of Transportation:</span>
                                        <span class="data-value" id="gen-modeOfTransportation">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Road Structure:</span>
                                        <span class="data-value" id="gen-roadStructure">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Urban/Rural Classification:</span>
                                        <span class="data-value" id="gen-urbanRural">-</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="data-row">
                                        <span class="data-label">Name of Parish:</span>
                                        <span class="data-value" id="gen-parish">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Diocese/Prelature Name:</span>
                                        <span class="data-value" id="gen-diocese">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Year of Residency:</span>
                                        <span class="data-value" id="gen-residency">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Number of Family Members:</span>
                                        <span class="data-value" id="gen-familyMembers">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Family Structure:</span>
                                        <span class="data-value" id="gen-familyStructure">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Local Dialect:</span>
                                        <span class="data-value" id="gen-dialect">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Ethnicity:</span>
                                        <span class="data-value" id="gen-ethnicity">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Primary Information -->
                        <div class="preview-section">
                            <h5>II. PRIMARY INFORMATION</h5>
                            
                            <h6 class="fw-bold mt-3 mb-2">Parents Profile</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Role</th>
                                            <th>Full Name</th>
                                            <th>Type of Marriage</th>
                                            <th>Religion</th>
                                            <th>Sex</th>
                                            <th>Age</th>
                                            <th>Highest Educ.</th>
                                            <th>Occupation</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="parentsTable">
                                        <tr>
                                            <td class="fw-bold">HH Head</td>
                                            <td id="head-name">-</td>
                                            <td id="head-marriage">-</td>
                                            <td id="head-religion">-</td>
                                            <td id="head-sex">-</td>
                                            <td id="head-age">-</td>
                                            <td id="head-educ">-</td>
                                            <td id="head-job">-</td>
                                            <td id="head-work">-</td>
                                        </tr>
                                        <tr>
                                            <td class="fw-bold">Spouse</td>
                                            <td id="spouse-name">-</td>
                                            <td id="spouse-marriage">-</td>
                                            <td id="spouse-religion">-</td>
                                            <td id="spouse-sex">-</td>
                                            <td id="spouse-age">-</td>
                                            <td id="spouse-educ">-</td>
                                            <td id="spouse-job">-</td>
                                            <td id="spouse-work">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <h6 class="fw-bold mt-4 mb-2">Household Members</h6>
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm member-table">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Name</th>
                                            <th>Relation</th>
                                            <th>Sex</th>
                                            <th>Age</th>
                                            <th>Civil Status</th>
                                            <th>Religion</th>
                                            <th>Sacraments</th>
                                            <th>Studying</th>
                                            <th>Educ.</th>
                                            <th>Occupation</th>
                                            <th>Status</th>
                                            <th>Immunized</th>
                                        </tr>
                                    </thead>
                                    <tbody id="membersTable">
                                        <!-- Members will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Health and Living Conditions -->
                        <div class="preview-section">
                            <h5>III. HEALTH AND LIVING CONDITIONS</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="data-row">
                                        <span class="data-label">Common Illnesses (Last 3 Months):</span>
                                        <span class="data-value" id="health-illness">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Treatment Source:</span>
                                        <span class="data-value" id="health-treatment">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Source of Potable Water:</span>
                                        <span class="data-value" id="health-water">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Lighting Energy Source:</span>
                                        <span class="data-value" id="health-lighting">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Cooking Energy Source:</span>
                                        <span class="data-value" id="health-cooking">-</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="data-row">
                                        <span class="data-label">Garbage Disposal:</span>
                                        <span class="data-value" id="health-garbage">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Toilet Facility:</span>
                                        <span class="data-value" id="health-toilet">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Distance from Water Source to Toilet:</span>
                                        <span class="data-value" id="health-toiletDist">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Socio-Economic and Infrastructure -->
                        <div class="preview-section">
                            <h5>IV. SOCIO-ECONOMIC AND INFRASTRUCTURE</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="data-row">
                                        <span class="data-label">Income per Month:</span>
                                        <span class="data-value" id="soc-income">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Expenses per Week:</span>
                                        <span class="data-value" id="soc-expenses">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Have Savings:</span>
                                        <span class="data-value" id="soc-savings">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Savings Location:</span>
                                        <span class="data-value" id="soc-savingsLoc">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">House/Lot Ownership:</span>
                                        <span class="data-value" id="soc-ownership">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">House Classification:</span>
                                        <span class="data-value" id="soc-houseClass">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Land Area (hectares):</span>
                                        <span class="data-value" id="soc-landArea">-</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="data-row">
                                        <span class="data-label">Appliances/Vehicle Owned:</span>
                                        <span class="data-value" id="soc-assets">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Livestock Owned:</span>
                                        <span class="data-value" id="soc-livestock">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Livestock for Others:</span>
                                        <span class="data-value" id="soc-livestockOther">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Distance from Church:</span>
                                        <span class="data-value" id="soc-church">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Distance from Market:</span>
                                        <span class="data-value" id="soc-market">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Missionary Companion:</span>
                                        <span class="data-value" id="soc-companion">-</span>
                                    </div>
                                    <div class="data-row">
                                        <span class="data-label">Date of Listing:</span>
                                        <span class="data-value" id="soc-date">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4 mb-4">
                            <button class="btn btn-secondary me-2" onclick="editSurvey()">
                                <i class="bi bi-pencil"></i> Edit Information
                            </button>
                            <button class="btn btn-success px-5 fw-semibold" onclick="submitSurvey()">
                                <i class="bi bi-check-circle"></i> Confirm & Submit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-dark text-white mt-auto">
      <div class="container py-2">
        <div class="row align-items-center">
          <div class="col-md-9">
            <h6 class="fw-bold mb-0">Household Survey Profiling</h6>
            <p class="small mb-0" style="font-size: 0.75rem">SJCB BSIT-2 Project</p>
          </div>
          <div class="col-md-3 text-md-end">
            <small class="fw-bold d-block d-md-inline me-2">Follow Us:</small>
            <a href="https://www.facebook.com/sjcbiofficial" class="text-white me-2"><i class="bi bi-facebook"></i></a>
          </div>
        </div>
      </div>
      <div class="text-center py-1 bg-success" style="font-size: 0.8rem">
        © 2026 SJCB BSIT-2 | All Rights Reserved
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.13.5/dist/axios.min.js"></script>
    <script>
        const religionMap = {
            '1': 'Roman Catholic',
            '2': 'Islam',
            '99': 'Others'
        };

        const sexMap = {
            '1': 'Male',
            '2': 'Female'
        };

        const workStatusMap = {
            '1': 'Regular',
            '2': 'Contractual',
            '3': 'Unemployed',
            '4': 'Self-Employed'
        };

        const relationMap = {
            'Son': 'Son',
            'Daughter': 'Daughter',
            'Stepson': 'Stepson',
            'Grandson': 'Grandson',
            'Relative': 'Relative',
            'Others': 'Others'
        };

        const roleMap = {
            'Head': 'HH Head',
            'Spouse': 'Spouse',
            'Member': 'Member'
        };

        const civilMap = {
            '1': 'Single',
            '2': 'Married',
            '3': 'Common Law',
            '4': 'Widowed'
        };

        const sacramentMap = {
            '1': 'None',
            '2': 'Baptism',
            '3': 'Confirmation'
        };

        const marriageMap = {
            '1': 'Civil',
            '2': 'Religious'
        };

        const studyingMap = {
            '1': 'Yes',
            '2': 'No'
        };

        const immunizedMap = {
            '1': 'Yes',
            '2': 'No',
            '66': 'N/A'
        };

        function getText(id, defaultVal = '-') {
            const el = document.getElementById(id);
            return el ? el.textContent : defaultVal;
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value || '-';
        }

        function loadSurveyData() {
            const general = JSON.parse(sessionStorage.getItem('survey_general') || '{}');
            const primary = JSON.parse(sessionStorage.getItem('survey_primary') || '{}');
            const health = JSON.parse(sessionStorage.getItem('survey_health') || '{}');
            const socio = JSON.parse(sessionStorage.getItem('survey_socio') || '{}');
            console.log(general);
            console.log(primary);
            setText('gen-purokGimong', general.purokGimong);
            setText('gen-barangayName', general.barangayName);
            setText('gen-municipalityselect', general['municipality-select'] || general.municipalityselect);
            setText('gen-provinceName', general.provinceName);
            setText('gen-modeOfTransportation', general.modeOfTransportation);
            setText('gen-roadStructure', general.road_Structure);
            setText('gen-urbanRural', general.urban_ruralClassification);
            setText('gen-parish', general.nameOfParish);
            setText('gen-diocese', general.diocesePrelatureName);
            setText('gen-residency', general.yrOfResInTheCommunity);
            setText('gen-familyMembers', general.numOfFamMembers);
            setText('gen-familyStructure', general.familyStructure);
            setText('gen-dialect', general.lclDialect);
            setText('gen-ethnicity', general.ethnicity);

            setText('head-name', primary.head_name);
            setText('head-marriage', marriageMap[primary.head_marriage]);
            setText('head-religion', religionMap[primary.head_religion]);
            setText('head-sex', sexMap[primary.head_sex]);
            setText('head-age', primary.head_age);
            setText('head-educ', primary.head_educ);
            setText('head-job', primary.head_job);
            setText('head-work', workStatusMap[primary.head_work_status]);

            setText('spouse-name', primary.spouse_name);
            setText('spouse-marriage', marriageMap[primary.spouse_marriage]);
            setText('spouse-religion', religionMap[primary.spouse_religion]);
            setText('spouse-sex', sexMap[primary.spouse_sex]);
            setText('spouse-age', primary.spouse_age);
            setText('spouse-educ', primary.spouse_educ);
            setText('spouse-job', primary.spouse_job);
            setText('spouse-work', workStatusMap[primary.spouse_work_status]);

            const membersTable = document.getElementById('membersTable');
            membersTable.innerHTML = '';

            if (primary.m_name && Array.isArray(primary.m_name)) {
                primary.m_name.forEach((name, idx) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${name || '-'}</td>
                        <td>${relationMap[primary.m_relation?.[idx]] || '-'}</td>
                        <td>${sexMap[primary.m_sex?.[idx]] || '-'}</td>
                        <td>${primary.m_age?.[idx] || '-'}</td>
                        <td>${civilMap[primary.m_civil?.[idx]] || '-'}</td>
                        <td>${religionMap[primary.m_religion?.[idx]] || '-'}</td>
                        <td>${sacramentMap[primary.m_sacraments?.[idx]] || '-'}</td>
                        <td>${studyingMap[primary.m_studying?.[idx]] || '-'}</td>
                        <td>${primary.m_educ?.[idx] || '-'}</td>
                        <td>${primary.m_job?.[idx] || '-'}</td>
                        <td>${workStatusMap[primary.m_work_status?.[idx]] || '-'}</td>
                        <td>${immunizedMap[primary.m_immunized?.[idx]] || '-'}</td>
                    `;
                    membersTable.appendChild(row);
                });
            }

            const illnessMap = {
                '00': 'None', '01': 'Fever', '02': 'Flu', '03': 'Cough',
                '04': 'Cold', '05': 'Diarrhea', '07': 'Asthma', '13': 'Heart Disease',
                '15': 'High Blood', '99': 'Others'
            };
            const treatmentMap = {
                '01': 'Traditional Healers', '02': 'Private Doctors',
                '05': 'Brgy. Health Station', '06': 'Rural Health Unit',
                '10': 'Private Clinic', '99': 'Others'
            };
            const waterMap = {
                '1': 'Local Water System', '5': 'Own Artesian Well',
                '11': 'Water Refilling Station', '12': 'NAWASA', '99': 'Others'
            };
            const lightingMap = {
                '1': 'Electricity', '2': 'Kerosene (Gaas)', '4': 'Solar Lamp', '99': 'Others'
            };
            const cookingMap = {
                '1': 'Woods', '2': 'Charcoal', '4': 'LPG', '5': 'Electricity', '99': 'Others'
            };
            const garbageMap = {
                '1': 'Segregating waste', '2': 'Collected by garbage truck',
                '6': 'Burning', '99': 'Others'
            };
            const toiletMap = {
                '1': 'Water-sealed flush (own)', '2': 'Water-sealed flush (shared)',
                '3': 'Closed pit', '5': 'No toilet'
            };
            const toiletDistMap = {
                '1': 'Below 200 meters', '2': '201-500 meters', '5': 'More than 1000 meters'
            };

            setText('health-illness', illnessMap[health.common_illness] || health.common_illness_others || '-');
            setText('health-treatment', treatmentMap[health.treatment_source] || health.treatment_source_others || '-');
            setText('health-water', waterMap[health.water_source] || health.water_source_others || '-');
            setText('health-lighting', lightingMap[health.lighting_source] || health.lighting_others || '-');
            setText('health-cooking', cookingMap[health.cooking_source] || health.cooking_others || '-');
            setText('health-garbage', garbageMap[health.garbage_disposal] || health.garbage_others || '-');
            setText('health-toilet', toiletMap[health.toilet_type] || '-');
            setText('health-toiletDist', toiletDistMap[health.toilet_distance] || '-');

            const incomeMap = {
                '1': '₱3,000 and below', '2': '₱3,001 - ₱6,000', '3': '₱6,001 - ₱9,000',
                '4': '₱9,001 - ₱12,000', '5': '₱12,001 - ₱15,000', '6': '₱15,001 - ₱18,000',
                '7': '₱18,001 - ₱21,000', '8': '₱21,001 - ₱24,000', '9': '₱24,001 - ₱27,000',
                '10': '₱27,001 - ₱30,000', '11': '₱30,001 and up'
            };
            const expensesMap = {
                '1': '₱300 and below', '2': '₱301 - ₱600', '3': '₱601 - ₱900',
                '4': '₱901 - ₱1,200', '5': '₱1,201 - ₱1,500', '6': '₱1,501 - ₱1,800',
                '7': '₱1,801 - ₱2,100', '8': '₱2,101 - ₱2,400', '9': '₱2,401 - ₱2,700',
                '10': '₱2,701 - ₱3,000', '11': '₱3,001 and up'
            };
            const savingsMap = {
                '1': 'Yes', '2': 'None'
            };
            const savingsLocMap = {
                '1': 'House', '2': 'Bank', '3': 'E-money (GCash, etc.)',
                '4': 'Microfinance / ASA', '99': 'Others', '66': 'Not Applicable'
            };
            const ownershipMap = {
                '1': 'Owned', '2': 'Rented House', '3': 'Tenanted',
                '4': 'Rent Free', '5': 'Caretaker', '99': 'Others'
            };
            const houseClassMap = {
                '1': 'Concrete', '2': 'Semi-Concrete', '3': 'Indigenous Materials',
                '4': 'Galvanized Iron / Aluminum', '5': 'Barong-barong', '6': 'Makeshift', '99': 'Others'
            };
            const distMap = {
                '1': 'Walking Distance (Ideal)', '2': '5-15 Minute Drive',
                '3': '30-Minute Drive', '4': 'Over 45 Minutes - 1 Hour+'
            };

            setText('soc-income', incomeMap[socio.income_monthly] || '-');
            setText('soc-expenses', expensesMap[socio.expenses_weekly] || '-');
            setText('soc-savings', savingsMap[socio.has_savings] || '-');
            setText('soc-savingsLoc', savingsLocMap[socio.savings_location] || '-');
            setText('soc-ownership', ownershipMap[socio.house_ownership] || '-');
            setText('soc-houseClass', houseClassMap[socio.house_classification] || '-');
            setText('soc-landArea', socio.land_area || '-');
            setText('soc-assets', socio.assets ? socio.assets.join(', ') : '-');
            setText('soc-livestock', socio.livestock_owned || '-');
            setText('soc-livestockOther', socio.livestock_for_others || '-');
            setText('soc-church', distMap[socio.distance_church] || '-');
            setText('soc-market', distMap[socio.distance_market] || '-');
            setText('soc-companion', socio.missionary_companion || '-');
            setText('soc-date', socio.listing_date || '-');
        }

        function editSurvey() {
            window.location.href = 'survey.html';
        }

        /**
         * Normalize field names to match backend expectations
         */
        function normalizeData(data) {
            if (!data || typeof data !== 'object') return data;
            
            const normalized = {};
            const keyMappings = {
                'municipality-select': 'municipalityName',
                'municipalityselect': 'municipalityName'
            };
            
            for (let key in data) {
                let value = data[key];
                
                // Map frontend field names to backend field names
                const mappedKey = keyMappings[key] || key;
                
                // Skip empty strings, placeholders, and disabled select values
                if (value === '' || 
                    value === 'Select a municipality' || 
                    value === 'Select number...' ||
                    value === 'Select structure...' ||
                    value === 'Choose classification' ||
                    value === 'Choose duration...' ||
                    value === 'Select type...' ||
                    value === 'Choose mode of transportation...' ||
                    value === 'Choose Road Structure' ||
                    value === null || 
                    value === undefined) {
                    value = null;
                }
                
                normalized[mappedKey] = value;
            }
            
            return normalized;
        }

        /**
         * Normalize array fields (assets[]) to proper format
         */
        function normalizeArrayFields(data) {
            if (!data || typeof data !== 'object') return data;
            
            const normalized = {};
            
            for (let key in data) {
                let value = data[key];
                
                // Handle assets[] array
                if (key === 'assets' && Array.isArray(value)) {
                    normalized[key] = value.filter(v => v && v !== '');
                } else {
                    normalized[key] = value;
                }
            }
            
            return normalized;
        }

        function submitSurvey() {
            let general = JSON.parse(sessionStorage.getItem('survey_general') || '{}');
            let primary = JSON.parse(sessionStorage.getItem('survey_primary') || '{}');
            let health = JSON.parse(sessionStorage.getItem('survey_health') || '{}');
            let socio = JSON.parse(sessionStorage.getItem('survey_socio') || '{}');

            // Normalize the data before sending
            general = normalizeData(general);
            primary = normalizeData(primary);
            health = normalizeData(health);
            socio = normalizeData(socio);
            socio = normalizeArrayFields(socio);

            const allData = { general, primary, health, socio };
            console.log('Submitting survey data (normalized):', allData);

            // Debug: Show what's being sent
            console.log('General data:', general);
            console.log('Primary data:', primary);
            console.log('Health data:', health);
            console.log('Socio data:', socio);

            Swal.fire({
                title: 'Submitting Survey...',
                text: 'Please wait while your data is being saved.',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            axios.post('https://survey-profiling-tool-backend.vercel.app/submit-survey', { data: allData })
            .then(response => {
                console.log(response);
                Swal.fire({
                    icon: 'success',
                    title: 'Thank you for your cooperation!',
                    text: 'Your data is submitted successfully!',
                    confirmButtonColor: '#457507',
                    timer: 3000,
                    timerProgressBar: true
                }).then(() => {
                    sessionStorage.clear();
                    window.location.href = 'index.html';
                });
            })  
            .catch(error => {
                console.error(error);
                let errorMessage = 'An error occurred while submitting your survey.';
                if (error.response) {
                    errorMessage = error.response.data?.error || error.response.statusText || errorMessage;
                } else if (error.request) {
                    errorMessage = 'Cannot connect to server. Please make sure the backend is running.';
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Submission Failed',
                    text: errorMessage,
                    confirmButtonColor: '#457507'
                });
            });  
        }

        window.onload = loadSurveyData;
    </script>
</body>

</html>